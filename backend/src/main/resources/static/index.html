<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커뮤니티</title>
    <link rel="stylesheet" href="css/common.css">
</head>
<body>
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <h1>커뮤니티</h1>
            </a>
            <nav class="nav" id="navigation">
                <div class="nav-guest" id="nav-guest">
                    <a href="login.html" class="btn btn-outline btn-sm">로그인</a>
                    <a href="register.html" class="btn btn-primary btn-sm">회원가입</a>
                </div>
                <div class="nav-user hidden" id="nav-user">
                    <span class="user-nickname" id="user-nickname"></span>
                    <a href="create-post.html" class="btn btn-primary btn-sm">글쓰기</a>
                    <button class="btn btn-outline btn-sm" id="logout-btn">로그아웃</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1>커뮤니티 게시판</h1>
                <p class="text-muted">자유롭게 소통해보세요!</p>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>게시글을 불러오는 중...</p>
            </div>

            <div class="error-banner hidden" id="error-banner">
                <p id="error-message"></p>
                <button class="btn btn-sm btn-primary" id="retry-btn">다시 시도</button>
            </div>

            <div class="empty-state hidden" id="empty-state">
                <h3>아직 게시글이 없습니다</h3>
                <p>첫 번째 글을 작성해보세요!</p>
                <a href="create-post.html" class="btn btn-primary">글쓰기</a>
            </div>

            <div id="post-list"></div>

            <div class="pagination hidden" id="pagination">
                <button class="btn btn-outline btn-sm" id="prev-btn" disabled>이전</button>
                <div class="page-numbers" id="page-numbers"></div>
                <button class="btn btn-outline btn-sm" id="next-btn">다음</button>
            </div>
        </div>
    </main>

    <script>
        function showElement(element) {
            if (element) element.classList.remove('hidden');
        }

        function hideElement(element) {
            if (element) element.classList.add('hidden');
        }

        const Auth = {
            TOKEN_KEY: 'community_token',
            USER_KEY: 'community_user',

            getCurrentUser() {
                const userString = localStorage.getItem(this.USER_KEY);
                return userString ? JSON.parse(userString) : null;
            },

            isAuthenticated() {
                return !!localStorage.getItem(this.TOKEN_KEY);
            },

            logout() {
                localStorage.removeItem(this.TOKEN_KEY);
                localStorage.removeItem(this.USER_KEY);
            }
        };

        function updateAuthUI() {
            const navGuest = document.getElementById('nav-guest');
            const navUser = document.getElementById('nav-user');
            const userNickname = document.getElementById('user-nickname');

            if (Auth.isAuthenticated()) {
                const user = Auth.getCurrentUser();
                
                hideElement(navGuest);
                showElement(navUser);
                
                if (userNickname && user) {
                    userNickname.textContent = user.nickname || user.email;
                }
            } else {
                showElement(navGuest);
                hideElement(navUser);
            }
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffInMs = now - date;
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            
            if (diffInDays === 0) {
                return date.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } else if (diffInDays === 1) {
                return '어제';
            } else if (diffInDays < 7) {
                return `${diffInDays}일 전`;
            } else {
                return date.toLocaleDateString('ko-KR');
            }
        }

        function truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function createPostCard(post) {
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            postCard.innerHTML = `
                <div class="post-card-header">
                    <h3 class="post-title">
                        <a href="post-detail.html?id=${post.id}">${post.title}</a>
                    </h3>
                    <div class="post-meta">
                        <span class="post-author">${post.authorNickname}</span>
                        <span class="post-date">${formatDateTime(post.createdAt)}</span>
                    </div>
                </div>
                <div class="post-content">
                    <p>${truncateText(post.content, 150)}</p>
                </div>
                <div class="post-stats">
                    <span class="post-likes">❤️ ${post.likeCount || 0}</span>
                    <span class="post-comments">💬 ${post.commentCount || 0}</span>
                </div>
            `;
            
            return postCard;
        }

        async function loadPosts() {
            const loading = document.getElementById('loading');
            const errorBanner = document.getElementById('error-banner');
            const postList = document.getElementById('post-list');
            const emptyState = document.getElementById('empty-state');

            try {
                console.log('Loading posts...');
                
                showElement(loading);
                hideElement(errorBanner);
                hideElement(emptyState);

                const response = await fetch('http://localhost:8080/api/posts?page=1&size=10');
                const result = await response.json();
                
                console.log('Posts response:', result);

                if (response.ok && result.posts && result.posts.length > 0) {
                    postList.innerHTML = '';
                    
                    result.posts.forEach(post => {
                        const postCard = createPostCard(post);
                        postList.appendChild(postCard);
                    });
                    
                    console.log(`${result.posts.length}개 게시글 표시 완료`);
                } else {
                    showElement(emptyState);
                }

            } catch (error) {
                console.error('Error loading posts:', error);
                
                const errorMessage = document.getElementById('error-message');
                if (errorMessage) {
                    errorMessage.textContent = '게시글을 불러오는 중 오류가 발생했습니다.';
                }
                
                showElement(errorBanner);
                
            } finally {
                hideElement(loading);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateAuthUI();
            loadPosts();

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    Auth.logout();
                    alert('로그아웃되었습니다.');
                    updateAuthUI();
                    location.reload();
                });
            }

            const retryBtn = document.getElementById('retry-btn');
            if (retryBtn) {
                retryBtn.addEventListener('click', () => loadPosts());
            }
        });
    </script>
</body>
</html>