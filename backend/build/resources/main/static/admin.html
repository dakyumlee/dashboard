<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 - 커뮤니티</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <h1>커뮤니티</h1>
            </a>
            <nav class="nav" id="navigation">
                <div class="nav-guest hidden" id="nav-guest">
                    <a href="login.html" class="btn btn-outline btn-sm">로그인</a>
                    <a href="register.html" class="btn btn-primary btn-sm">회원가입</a>
                </div>
                <div class="nav-user hidden" id="nav-user">
                    <span class="user-nickname" id="user-nickname"></span>
                    <a href="create-post.html" class="btn btn-primary btn-sm">글쓰기</a>
                    <button class="btn btn-outline btn-sm" id="logout-btn">로그아웃</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>관리자 페이지를 불러오는 중...</p>
            </div>

            <div class="error-banner hidden" id="error-banner">
                <p id="error-message"></p>
                <a href="index.html" class="btn btn-sm btn-primary">메인으로</a>
            </div>

            <div class="admin-container hidden" id="admin-container">
                <div class="admin-header">
                    <h1>관리자 페이지</h1>
                    <p class="text-muted">게시글과 댓글을 관리할 수 있습니다</p>
                </div>

                <div class="admin-tabs">
                    <button class="admin-tab active" data-tab="posts" id="posts-tab">
                        게시글 관리
                    </button>
                    <button class="admin-tab" data-tab="comments" id="comments-tab">
                        댓글 관리
                    </button>
                </div>

                <div class="admin-content">
                    <div class="admin-panel active" id="posts-panel">
                        <div class="panel-header">
                            <h3>게시글 관리</h3>
                            <div class="panel-actions">
                                <button class="btn btn-secondary btn-sm" id="refresh-posts-btn">새로고침</button>
                            </div>
                        </div>

                        <div class="admin-table-container">
                            <table class="admin-table" id="posts-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>제목</th>
                                        <th>작성자</th>
                                        <th>작성일</th>
                                        <th>좋아요</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="posts-tbody">
                                </tbody>
                            </table>
                        </div>

                        <div class="pagination hidden" id="posts-pagination">
                            <button class="btn btn-outline btn-sm" id="posts-prev-btn" disabled>이전</button>
                            <div class="page-numbers" id="posts-page-numbers"></div>
                            <button class="btn btn-outline btn-sm" id="posts-next-btn">다음</button>
                        </div>
                    </div>

                    <div class="admin-panel" id="comments-panel">
                        <div class="panel-header">
                            <h3>댓글 관리</h3>
                            <div class="panel-actions">
                                <button class="btn btn-secondary btn-sm" id="refresh-comments-btn">새로고침</button>
                            </div>
                        </div>

                        <div class="admin-table-container">
                            <table class="admin-table" id="comments-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>내용</th>
                                        <th>게시글</th>
                                        <th>작성자</th>
                                        <th>작성일</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="comments-tbody">
                                </tbody>
                            </table>
                        </div>

                        <div class="pagination hidden" id="comments-pagination">
                            <button class="btn btn-outline btn-sm" id="comments-prev-btn" disabled>이전</button>
                            <div class="page-numbers" id="comments-page-numbers"></div>
                            <button class="btn btn-outline btn-sm" id="comments-next-btn">다음</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal hidden" id="delete-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="delete-modal-title">삭제 확인</h3>
            </div>
            <div class="modal-body">
                <p id="delete-modal-message">정말로 삭제하시겠습니까?</p>
                <p class="text-muted text-sm">삭제된 내용은 복구할 수 없습니다.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="delete-cancel-btn">취소</button>
                <button class="btn btn-danger" id="delete-confirm-btn">삭제</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        let currentUser = null;
        let currentDeleteItem = null;
        let currentTab = 'posts';
        let postsPage = 0;
        let commentsPage = 0;

        document.addEventListener('DOMContentLoaded', function() {
            initAdminPage();
        });

        function initAdminPage() {
            if (!checkAdminAuth()) {
                return;
            }
            
            setupEventListeners();
            showAdminContainer();
            loadPosts();
        }

        function checkAdminAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                showError('로그인이 필요합니다.');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return false;
            }
            
            const payload = JSON.parse(atob(token.split('.')[1]));
            currentUser = {
                id: payload.sub,
                nickname: payload.nickname,
                role: payload.role
            };
            
            if (currentUser.role !== 'ADMIN') {
                showError('관리자 권한이 없습니다.');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return false;
            }
            
            updateNavigation();
            return true;
        }

        function updateNavigation() {
            document.getElementById('nav-guest').classList.add('hidden');
            document.getElementById('nav-user').classList.remove('hidden');
            document.getElementById('user-nickname').textContent = currentUser.nickname;
        }

        function showAdminContainer() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('admin-container').classList.remove('hidden');
        }

        function setupEventListeners() {
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            document.getElementById('posts-tab').addEventListener('click', () => switchTab('posts'));
            document.getElementById('comments-tab').addEventListener('click', () => switchTab('comments'));
            
            document.getElementById('refresh-posts-btn').addEventListener('click', () => loadPosts());
            document.getElementById('refresh-comments-btn').addEventListener('click', () => loadComments());
            
            document.getElementById('delete-cancel-btn').addEventListener('click', hideDeleteModal);
            document.getElementById('delete-confirm-btn').addEventListener('click', confirmDelete);
        }

        function switchTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
            
            document.getElementById(`${tab}-tab`).classList.add('active');
            document.getElementById(`${tab}-panel`).classList.add('active');
            
            if (tab === 'posts') {
                loadPosts();
            } else if (tab === 'comments') {
                loadComments();
            }
        }

        async function loadPosts() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/posts?page=${postsPage}&size=10`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('게시글을 불러올 수 없습니다.');
                }

                const data = await response.json();
                displayPosts(data.content);

            } catch (error) {
                console.error('게시글 로드 실패:', error);
                alert('게시글을 불러오는데 실패했습니다.');
            }
        }

        function displayPosts(posts) {
            const tbody = document.getElementById('posts-tbody');
            tbody.innerHTML = '';

            posts.forEach(post => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${post.id}</td>
                    <td class="title-cell">
                        <a href="post-detail.html?id=${post.id}" class="title-link" target="_blank">
                            ${escapeHtml(post.title)}
                        </a>
                    </td>
                    <td>${escapeHtml(post.authorNickname)}</td>
                    <td>${new Date(post.createdAt).toLocaleDateString('ko-KR')}</td>
                    <td>${post.likeCount || 0}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deletePost(${post.id})">삭제</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadComments() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/comments?page=${commentsPage}&size=10`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('댓글을 불러올 수 없습니다.');
                }

                const data = await response.json();
                displayComments(data.content);

            } catch (error) {
                console.error('댓글 로드 실패:', error);
                alert('댓글을 불러오는데 실패했습니다.');
            }
        }

        function displayComments(comments) {
            const tbody = document.getElementById('comments-tbody');
            tbody.innerHTML = '';

            comments.forEach(comment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${comment.id}</td>
                    <td class="content-cell">${escapeHtml(comment.content.substring(0, 50))}${comment.content.length > 50 ? '...' : ''}</td>
                    <td>
                        <a href="post-detail.html?id=${comment.postId}" class="title-link" target="_blank">
                            ${escapeHtml(comment.postTitle)}
                        </a>
                    </td>
                    <td>${escapeHtml(comment.authorNickname)}</td>
                    <td>${new Date(comment.createdAt).toLocaleDateString('ko-KR')}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteComment(${comment.id})">삭제</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deletePost(postId) {
            currentDeleteItem = { type: 'post', id: postId };
            document.getElementById('delete-modal-title').textContent = '게시글 삭제';
            document.getElementById('delete-modal-message').textContent = '정말로 이 게시글을 삭제하시겠습니까?';
            showDeleteModal();
        }

        function deleteComment(commentId) {
            currentDeleteItem = { type: 'comment', id: commentId };
            document.getElementById('delete-modal-title').textContent = '댓글 삭제';
            document.getElementById('delete-modal-message').textContent = '정말로 이 댓글을 삭제하시겠습니까?';
            showDeleteModal();
        }

        function showDeleteModal() {
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        function hideDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
            currentDeleteItem = null;
        }

        async function confirmDelete() {
            if (!currentDeleteItem) return;

            try {
                const endpoint = currentDeleteItem.type === 'post' 
                    ? `posts/${currentDeleteItem.id}`
                    : `comments/${currentDeleteItem.id}`;

                const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('삭제에 실패했습니다.');
                }

                alert('삭제되었습니다.');
                hideDeleteModal();

                if (currentDeleteItem.type === 'post') {
                    loadPosts();
                } else {
                    loadComments();
                }

            } catch (error) {
                alert(error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-banner').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>